name: Build Gennaro AI FAP for Momentum

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git wget curl build-essential
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Clone Momentum firmware
      run: |
        git clone --recursive --depth 1 https://github.com/Next-Flip/Momentum-Firmware.git
        cd Momentum-Firmware
        git submodule update --init --recursive
        
    - name: Install FBT dependencies
      run: |
        cd Momentum-Firmware
        ./fbt
        
    - name: Create app directory structure
      run: |
        mkdir -p Momentum-Firmware/applications/external/gennaro_ai
        
    - name: Copy and verify application files
      run: |
        echo "=== Repository files ==="
        ls -la
        echo "=== Copying application.fam ==="
        cp application.fam Momentum-Firmware/applications/external/gennaro_ai/
        echo "=== Copying gennaro_ai.c ==="
        cp gennaro_ai.c Momentum-Firmware/applications/external/gennaro_ai/
        echo "=== Target directory contents ==="
        ls -la Momentum-Firmware/applications/external/gennaro_ai/
        echo "=== application.fam content ==="
        cat Momentum-Firmware/applications/external/gennaro_ai/application.fam
        
    - name: Build FAP with Momentum
      run: |
        cd Momentum-Firmware
        echo "=== Building all external FAPs ==="
        ./fbt faps
        echo "=== Checking build directory ==="
        ls -la build/f*/dist/faps/ || echo "Build directory not found"
        echo "=== Search for our FAP ==="
        find . -name "*gennaro*.fap" -type f
        find . -name "gennaro_ai.fap" -type f
        
    - name: Copy FAP file
      run: |
        echo "=== Looking for gennaro_ai FAP ==="
        find Momentum-Firmware -name "gennaro_ai.fap" -type f -exec cp {} ./ \;
        find Momentum-Firmware -name "*gennaro*.fap" -type f -exec cp {} ./ \;
        echo "=== FAP files in current directory ==="
        ls -la *.fap || echo "No FAP files found"
        
    - name: Upload FAP file
      uses: actions/upload-artifact@v4
      with:
        name: gennaro_ai_momentum_fap
        path: "*.fap"
        retention-days: 30
        if-no-files-found: warn
        
    - name: Upload all FAPs for debugging
      if: always()
      run: |
        echo "=== Creating debug FAP collection ==="
        mkdir -p debug_faps
        find Momentum-Firmware -name "*.fap" -type f -exec cp {} debug_faps/ \; || echo "No FAPs found"
        ls -la debug_faps/ || echo "Debug faps directory empty"
        
    - name: Upload debug FAPs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: all_momentum_faps_debug
        path: debug_faps/
        retention-days: 7
        if-no-files-found: ignore
        
    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: momentum_build_logs
        path: |
          Momentum-Firmware/build/
          Momentum-Firmware/.fbt/
        retention-days: 7
        if-no-files-found: ignore
