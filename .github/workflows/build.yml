name: Build Gennaro AI for Official Firmware

on:
  push:
    branches: [main, master, dev]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git wget curl build-essential python3
        
    - name: Clone Official Flipper firmware
      run: |
        git clone --recursive --depth 1 https://github.com/flipperdevices/flipperzero-firmware.git
        cd flipperzero-firmware
        git submodule update --init --recursive
        
    - name: Create icon
      run: |
        python3 -c "
        import base64
        data = base64.b64decode('iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAdgAAAHYBTnsmCAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAABYSURBVBiVpY+xDQAgCAS/xgk6gx3AlThCJ3AER+gMduAEJsbGhISGXHI/jyQAAP//ZgZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmaH8AEMU5AK1dCd/gAAAABJRU5ErkJggg==')
        open('icon.png', 'wb').write(data)
        "
        
    - name: Setup app
      run: |
        mkdir -p flipperzero-firmware/applications/external/gennaro_ai
        cp gennaro_ai.c flipperzero-firmware/applications/external/gennaro_ai/
        cp application.fam flipperzero-firmware/applications/external/gennaro_ai/
        cp icon.png flipperzero-firmware/applications/external/gennaro_ai/
        
    - name: Build
      run: |
        cd flipperzero-firmware
        ./fbt fap_dist
        
    - name: Find and copy FAP
      run: |
        cd flipperzero-firmware
        find . -name "*gennaro*.fap" -exec cp {} ../gennaro_ai.fap \;
        
    - name: Upload FAP
      uses: actions/upload-artifact@v4
      with:
        name: gennaro_ai_official
        path: gennaro_ai.fap
